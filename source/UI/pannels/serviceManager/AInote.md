# 服务管理面板

## 基本功能
服务管理面板用于监控和管理插件的各项服务，包括主HTTP服务和静态资源服务。面板提供了直观的界面，显示各个服务的运行状态、端口号、启动时间以及运行时长等关键信息，并允许用户通过界面对服务进行启动、停止和重启操作。

## 实现原理

### 服务状态检测机制
服务状态检测采用多层次的心跳机制：

1. **增强型心跳响应**：
   - 服务器向客户端发送包含详细状态信息的心跳响应，包括服务运行状态、启动时间、端口号等
   - 心跳响应通过IPC通道传递，确保跨进程通信的可靠性
   - 每次心跳包含时间戳，用于计算服务响应延迟和运行时长

2. **状态缓存机制**：
   - 插件主实例维护服务状态缓存(`servicesStatus`)，存储最新的服务状态信息
   - 状态更新时通过事件总线广播状态变化，实现松耦合的状态通知机制
   - 面板组件订阅状态更新事件，实时反映服务状态变化

3. **定时检测与手动检测结合**：
   - 插件实例每5秒自动触发一次服务状态检测
   - 用户可通过面板手动刷新，立即获取最新服务状态
   - 自动检测失败时降级到上次已知状态，避免状态抖动

4. **故障检测与恢复**：
   - 检测到服务停止时立即触发对应事件(server:stopped/staticServer:stopped)
   - 服务恢复时自动更新状态并反映在界面上
   - 提供友好的服务启动/停止/重启接口，支持用户干预修复服务

### 事件响应机制
服务管理面板采用事件驱动架构，使用事件总线实现组件间的解耦和通信：

- `service:status-updated` - 服务状态更新事件，携带服务类型和最新状态信息
- `server:start/stop` - 控制主服务启动/停止
- `staticServer:start/stop` - 控制静态服务启动/停止
- `server:stopped/staticServer:stopped` - 服务意外停止的通知事件

面板组件在挂载时注册事件监听器，并在卸载时移除监听器，遵循Vue组件生命周期最佳实践。

### 加载方式优化
为解决MIME类型错误问题，服务管理面板采用了以下优化：

1. 传统脚本加载替代ES模块加载，避免严格的MIME类型要求
2. 创建全局Vue实例而非使用ESM imports
3. 两阶段加载过程确保依赖按正确顺序加载
4. 注册函数暴露到全局作用域，便于非模块环境调用

## 设计思考

服务管理面板设计遵循以下原则：

1. **可靠性优先**：状态检测采用多重机制确保可靠性，即使在网络不稳定情况下也能反映真实服务状态
2. **用户体验导向**：提供友好界面和及时反馈，包括状态指示器、运行时长和上次更新时间等信息
3. **解耦与组件化**：使用事件总线实现松耦合架构，便于维护和扩展
4. **性能优化**：状态缓存机制减少不必要的请求，定时更新与手动刷新结合优化资源使用

## 心跳通信机制改进

最新版本对心跳通信机制进行了重大改进：

1. **结构化状态数据**：
   - 心跳响应现包含完整的服务状态对象，包括主服务和静态服务的详细信息
   - 每个服务状态包含isRunning、port、startTime和lastHeartbeat等关键字段
   - 使用统一的数据结构确保状态表示的一致性

2. **实时状态广播**：
   - 状态变更时即时广播事件，确保UI组件能够立即响应变化
   - 使用事件总线机制避免轮询，减少系统开销
   - 广播事件包含变更的具体服务和完整状态信息，支持细粒度UI更新

3. **历史状态追踪**：
   - 记录每个服务的启动时间和最后心跳时间
   - 支持计算服务运行时长和响应延迟
   - 提供直观时间表示（如"几分钟前"、"几小时前"）增强用户体验

4. **自动恢复机制**：
   - 心跳通信失败后自动重试
   - 保持上次已知状态并明确标示更新时间
   - 服务恢复后自动同步最新状态

## 扩展思路

1. **服务健康度评分**：
   - 基于心跳响应时间、稳定性等指标计算服务健康度
   - 提供长期趋势分析，预测潜在问题

2. **服务资源监控**：
   - 扩展心跳数据包含CPU、内存使用情况
   - 增加资源使用图表直观显示服务负载变化

3. **日志集成**：
   - 在面板中直接显示服务关键日志
   - 提供日志过滤和搜索功能

4. **通知系统**：
   - 服务状态变化时发送系统通知
   - 允许用户设置关注的服务和通知触发条件 