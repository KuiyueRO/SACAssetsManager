<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>窗口内容</title>
  <link rel="stylesheet" href="./styles.css">
  <!-- 导入应用的主要样式 -->
</head>
<body>
  <div id="app">
    <div class="loading-container" v-if="!componentLoaded">
      <div class="loading-spinner"></div>
      <div class="loading-text">加载组件中...</div>
    </div>
    
    <component 
      v-else
      :is="dynamicComponent" 
      v-bind="componentProps"
      v-bind="componentData"
      @update="handleComponentUpdate"
      @event="handleComponentEvent">
    </component>
  </div>
  
  <script type="module">
    // 导入Vue基本库
    import { createApp, defineAsyncComponent, h, ref, reactive, toRefs } from '../../../../static/vue.esm-browser.js';
    import { initVueApp } from "../../../utils/module/vue/loadVueApp.js";

    // 创建窗口应用
    const app = createApp({
      setup() {
        // 状态定义
        const state = reactive({
          // 窗口数据
          windowId: null,
          sourceWindowId: null,
          title: '窗口内容',
          // 组件数据
          componentPath: '',
          componentProps: {},
          componentData: {},
          // 组件加载状态
          componentLoaded: false,
          dynamicComponent: null,
          // 错误状态
          loadError: null
        });
        
        // 导入electron模块
        const { ipcRenderer } = window.require('electron');
        
        /**
         * 动态加载组件, 使用vue3-sfc-loader加载组件
         * 
         */
        async function loadComponent(path) {
          if (!path) {
            state.loadError = '未提供组件路径';
            return;
          }
          
          try {
            // 使用动态导入加载组件
            const module = await import(path);
            state.dynamicComponent = module.default;
            state.componentLoaded = true;
          } catch (error) {
            console.error('加载组件失败:', error);
            state.loadError = `加载组件失败: ${error.message}`;
          }
        }
        
        /**
         * 处理组件更新事件
         */
        function handleComponentUpdate(data) {
          // 更新本地数据
          state.componentData = {...state.componentData, ...data};
          
          // 将更新发送给父窗口
          sendDataToParent(data);
        }
        
        /**
         * 处理组件事件
         */
        function handleComponentEvent(eventName, eventData) {
          // 将事件发送给父窗口
          sendEventToParent(eventName, eventData);
        }
        
        /**
         * 向父窗口发送数据更新
         */
        function sendDataToParent(data) {
          if (state.windowId && state.sourceWindowId) {
            ipcRenderer.send('window-data-update', {
              sourceWindowId: state.windowId,
              targetWindowId: state.sourceWindowId,
              updatedData: data
            });
          }
        }
        
        /**
         * 向父窗口发送事件
         */
        function sendEventToParent(eventName, eventData) {
          if (state.windowId && state.sourceWindowId) {
            ipcRenderer.send('window-event', {
              sourceWindowId: state.windowId,
              targetWindowId: state.sourceWindowId,
              eventName,
              eventData
            });
          }
        }
        
        /**
         * 通知父窗口此窗口已关闭
         */
        function notifyWindowClosed() {
          if (state.windowId && state.sourceWindowId) {
            ipcRenderer.send('window-closed', {
              sourceWindowId: state.windowId,
              targetWindowId: state.sourceWindowId
            });
          }
        }
        
        /**
         * 设置IPC监听器
         */
        function setupIpcListeners() {
          // 监听初始化消息
          ipcRenderer.once('window-init', async (event, data) => {
            // 更新窗口数据
            state.windowId = data.windowId;
            state.sourceWindowId = data.sourceWindowId;
            state.title = data.title || '窗口内容';
            
            // 更新组件信息
            state.componentPath = data.componentPath;
            state.componentProps = data.componentProps || {};
            state.componentData = data.componentData || {};
            
            // 设置文档标题
            document.title = state.title;
            
            // 加载组件
            await loadComponent(state.componentPath);
          });
          
          // 监听数据更新
          ipcRenderer.on('parent-data-update', (event, data) => {
            if (data.targetWindowId === state.windowId) {
              state.componentData = {...state.componentData, ...data.updatedData};
            }
          });
          
          // 监听属性更新
          ipcRenderer.on('component-props-update', (event, data) => {
            if (data.targetWindowId === state.windowId) {
              state.componentProps = {...state.componentProps, ...data.componentProps};
            }
          });
          
          // 监听父窗口事件
          ipcRenderer.on('parent-event', (event, data) => {
            if (data.targetWindowId === state.windowId && state.dynamicComponent) {
              // 向组件触发事件
              state.dynamicComponent.$emit(data.eventName, data.eventData);
            }
          });
          
          // 监听关闭消息
          ipcRenderer.on('window-close', () => {
            notifyWindowClosed();
          });
        }
        
        /**
         * 移除IPC监听器
         */
        function removeIpcListeners() {
          ipcRenderer.removeAllListeners('parent-data-update');
          ipcRenderer.removeAllListeners('component-props-update');
          ipcRenderer.removeAllListeners('parent-event');
          ipcRenderer.removeAllListeners('window-close');
        }
        
        // 设置IPC监听器
        setupIpcListeners();
        
        // 组件卸载时清理资源
        window.addEventListener('beforeunload', () => {
          notifyWindowClosed();
          removeIpcListeners();
        });
        
        return {
          ...toRefs(state),
          handleComponentUpdate,
          handleComponentEvent
        };
      }
    });
    
    // 挂载应用
    app.mount('#app');
  </script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background-color: #f9f9f9;
      height: 100vh;
      overflow: hidden;
    }
    
    #app {
      height: 100%;
      width: 100%;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: #666;
      font-size: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>