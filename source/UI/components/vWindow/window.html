<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>窗口内容</title>
  <link rel="stylesheet" href="./styles.css">
  <!-- 导入应用的主要样式 -->
</head>
<body>
  <div id="app">
    <div class="loading-container" v-if="!componentLoaded">
      <div class="loading-spinner"></div>
      <div class="loading-text">加载组件中...</div>
    </div>
    
    <div class="error-container" v-else-if="loadError">
      <div class="error-message">{{ loadError }}</div>
    </div>
    
    <component 
      v-else
      :is="dynamicComponent" 
      v-bind="componentProps"
      v-bind="getEventHandlers()"
      @update="handleComponentUpdate">
    </component>
  </div>
  
  <script type="module">
    // 导入Vue基本库
    import { createApp, defineAsyncComponent, h, ref, reactive, toRefs } from '../../../../static/vue.esm-browser.js';
    import * as Vue from '../../../../static/vue.esm-browser.js';
    import { initVueApp } from "../../../utils/module/vue/loadVueApp.js";
    import { ComponentSerializer } from '../../../../src/toolBox/feature/useVue/useSFC/forComponentSerialize.js';

    // 创建窗口应用
    const app = createApp({
      setup() {
        // 状态定义
        const state = reactive({
          // 窗口数据
          channelId: '',
          title: '窗口内容',
          // 组件数据
          serializedComponent: null,
          componentProps: {},
          // 组件加载状态
          componentLoaded: false,
          dynamicComponent: null,
          // 错误状态
          loadError: null,
          // 通信频道
          channel: null,
          eventNames: [], // 存储可用的事件名称列表
        });
        
        /**
         * 从URL获取通信频道ID
         */
        function getChannelIdFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get('channelId');
        }
        
        /**
         * 设置通信频道
         */
        function setupChannel() {
          const channelId = getChannelIdFromUrl();
          if (!channelId) {
            state.loadError = '无法获取通信频道ID';
            return;
          }
          
          state.channelId = channelId;
          state.channel = new BroadcastChannel(`vWindow-${channelId}`);
          
          // 设置消息监听
          state.channel.onmessage = async (event) => {
            const { type, payload } = event.data;
            
            switch (type) {
              case 'COMPONENT_DATA':
                // 更新窗口数据
                state.title = payload.title || '窗口内容';
                state.serializedComponent = payload.serializedComponent;
                state.componentProps = payload.componentProps || {};
                state.eventNames = payload.eventNames || [];
                
                // 设置文档标题
                document.title = state.title;
                
                // 加载组件
                await loadComponent();
                break;
                
              case 'COMPONENT_ERROR':
                state.loadError = `加载组件失败: ${payload.error}`;
                break;
                
              case 'PARENT_DATA_UPDATE':
                // 更新组件数据
                if (state.componentLoaded) {
                  // 应用数据更新
                }
                break;
                
              case 'COMPONENT_PROPS_UPDATE':
                // 更新组件属性
                if (state.componentLoaded) {
                  state.componentProps = {...state.componentProps, ...payload.props};
                }
                break;
                
              case 'PARENT_EVENT':
                // 触发组件事件
                if (state.componentLoaded && state.dynamicComponent) {
                  // 向组件触发事件
                  state.dynamicComponent.$emit(payload.name, payload.data);
                }
                break;
            }
          };
          
          // 请求组件数据
          state.channel.postMessage({
            type: 'REQUEST_COMPONENT',
            payload: {}
          });
        }
        
        /**
         * 动态加载组件
         */
        async function loadComponent() {
          try {
            if (state.serializedComponent) {
              // 使用ComponentSerializer反序列化组件
              const context = {
                vue: Vue,
                _vue: Vue
              };
              
              state.dynamicComponent = await ComponentSerializer.deserialize(
                state.serializedComponent, 
                context
              );
              console.log(state.dynamicComponent)
              state.componentLoaded = true;
            } else {
              state.loadError = '未提供组件定义';
            }
          } catch (error) {
            console.error('加载组件失败:', error);
            state.loadError = `加载组件失败: ${error.message}`;
          }
        }
        
        /**
         * 处理组件更新事件
         */
        function handleComponentUpdate(data) {
          if (state.channel) {
            state.channel.postMessage({
              type: 'DATA_UPDATED',
              payload: { data }
            });
          }
        }
        
        /**
         * 处理组件事件
         */
        function handleComponentEvent(eventName, eventData) {
          // 向主窗口发送事件
          if (state.channel) {
            state.channel.postMessage({
              type: 'COMPONENT_EVENT',
              payload: { 
                name: eventName,
                data: eventData
              }
            });
          }
        }
        
        // 返回事件处理函数
        function getEventHandlers() {
          const handlers = {};
          
          // 为每个事件名称创建处理函数
          (state.eventNames || []).forEach(name => {
            handlers[`on${name.charAt(0).toUpperCase() + name.slice(1)}`] = (eventData) => {
              handleComponentEvent(name, eventData);
            };
          });
          
          return handlers;
        }
        
        // 窗口关闭前通知主窗口
        window.addEventListener('beforeunload', () => {
          if (state.channel) {
            state.channel.postMessage({
              type: 'WINDOW_CLOSED',
              payload: {}
            });
            state.channel.close();
          }
        });
        
        // 初始化通信频道
        setupChannel();
        
        return {
          ...toRefs(state),
          getEventHandlers, // 暴露给模板
          handleComponentUpdate
        };
      }
    });
    
    // 挂载应用
    app.mount('#app');
  </script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background-color: #f9f9f9;
      height: 100vh;
      overflow: hidden;
    }
    
    #app {
      height: 100%;
      width: 100%;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: #666;
      font-size: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>