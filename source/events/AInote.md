# 事件系统重构笔记

## 重构状态

事件系统正在重构中，计划将所有事件处理逻辑迁移到`src/events`目录。

## 职责范围

- 提供事件发布订阅机制
- 管理全局和局部事件
- 处理编辑器相关事件
- 连接不同模块的通信

## 重构原则

1. **统一事件模型**：
   - 统一事件的命名和结构
   - 标准化事件参数格式
   - 规范化事件流程控制

2. **性能优化**：
   - 减少不必要的事件触发
   - 优化事件处理器执行
   - 实现事件队列和批处理

3. **开发体验提升**：
   - 增强事件调试能力
   - 提供类型安全的接口
   - 简化事件注册和管理

4. **渐进式迁移**：
   - 保持向后兼容性
   - 创建事件适配层
   - 增量更新核心功能

## 迁移计划

### 第一阶段：事件基础设施（进行中）

- 核心事件总线
- 事件类型定义系统
- 基础调试工具

### 第二阶段：编辑器事件（计划中）

- 编辑器选择事件
- 内容变更事件
- 光标位置事件

### 第三阶段：应用事件（计划中）

- 用户界面事件
- 配置变更事件
- 应用生命周期事件

### 第四阶段：高级功能（计划中）

- 事件重放功能
- 事件记录和分析
- 跨实例事件同步

## 目录迁移映射

| 现有目录/文件 | 目标位置 | 优先级 | 状态 | 备注 |
|--------------|---------|-------|------|------|
| globalEvents.js | src/events/global.js | 高 | 进行中 | 全局事件管理 |
| eventNames.js | src/events/constants.js | 高 | 待开始 | 事件名称常量 |
| assets.js | src/events/assets.js | 中 | 待开始 | 资源事件管理 |
| editorEvents/ | src/events/editor/ | 高 | 进行中 | 编辑器事件处理 |

## 特殊处理说明

### 事件冒泡和捕获

新的事件系统将实现完整的事件冒泡和捕获机制：

1. 定义事件传播路径和方向
2. 支持事件停止传播选项
3. 实现事件阶段控制（捕获/目标/冒泡）
4. 提供事件委托能力

### 异步事件处理

事件处理需要支持异步操作：

1. 支持异步事件处理器
2. 提供事件序列化和排队机制
3. 实现事件超时处理
4. 处理并发和竞争条件

### 事件回溯

为调试和测试目的，实现事件回溯功能：

1. 记录关键事件序列
2. 支持事件重放和模拟
3. 提供事件时间线视图
4. 实现事件快照和恢复

## 关键挑战

1. **循环引用**：
   - 事件系统被多个模块依赖
   - 避免循环依赖导致的初始化问题
   - 使用依赖注入或延迟加载解决

2. **事件风暴**：
   - 防止事件处理触发过多连锁事件
   - 实现事件限流和去重
   - 监控和防御事件循环

3. **跨模块通信**：
   - 维护跨模块事件的一致性
   - 定义清晰的事件契约
   - 管理事件依赖关系

4. **向后兼容**：
   - 支持旧的事件API格式
   - 提供兼容层适配器
   - 平滑过渡到新接口

## 测试策略

1. **单元测试**：
   - 测试核心事件机制
   - 验证事件处理逻辑
   - 模拟不同事件场景

2. **集成测试**：
   - 测试跨模块事件交互
   - 验证事件流正确性
   - 测试事件传播机制

3. **性能测试**：
   - 测试高频事件处理性能
   - 验证大量并发事件的处理
   - 识别性能瓶颈

## 重构日志

| 日期 | 工作内容 | 状态 | 负责人 |
|------|---------|------|-------|
| 2023-12-10 | 事件系统架构设计 | 完成 | 团队 |
| 2024-01-05 | 事件总线核心实现 | 完成 | AI助手 |
| 2024-01-20 | 编辑器事件适配器 | 进行中 | AI助手 |
| 2024-02-15 | 事件调试工具开发 | 待开始 | 团队 |

## 最佳实践

1. **事件命名约定**：
   - 使用`动词:主体:动作`格式（如`editor:text:changed`）
   - 使用恒定字符串而非动态生成的名称
   - 在常量文件中集中定义所有事件名

2. **事件参数设计**：
   - 传递完整对象而非散列参数
   - 使用可选链和默认值处理缺失参数
   - 避免在事件对象中包含大型数据结构

3. **事件响应优化**：
   - 使用节流和防抖控制高频事件
   - 批量处理相关事件
   - 优先同步处理关键事件

## 注意事项

- 每个模块只订阅与自身相关的事件
- 事件处理器应该职责单一，避免副作用
- 明确记录事件依赖和触发条件
- 在组件卸载时清理事件订阅
- 记录和监控关键事件以便调试 