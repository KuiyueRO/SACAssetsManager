<script type="module">
    import '../utils/hack/hackRequire.js'
    function getExternalBase() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('externalBase');
    }
    function getPort() {
        const urlParams = new URLSearchParams(window.location.search);
        return parseInt(urlParams.get('port'));
    }
    const externalBase = getExternalBase();
    require.setExternalBase(externalBase)

    const express = require('express')
    const app = express()
    const port = getPort()
    
    // 添加 raw 图片接口
    app.get('/raw', (req, res) => {
        const path = req.query.path;
        const localPath = req.query.localPath;
        // 根据是否有 localPath 参数决定使用哪个路径
        const imagePath = localPath || (externalBase + path);
        // 直接返回图片文件
        res.sendFile(imagePath, (err) => {
            if (err) {
                console.error('发送图片文件失败:', err);
                res.status(404).send('图片未找到');
            }
        });
    });
    
    const thumbnailCache = new Map();
    app.get('/thumbnail', async (req, res) => {
        const targetUrl = `http://127.0.0.1:${port - 1}${req.url}`;
        
        const cacheKey = req.url;
        console.log(`[缩略图代理] 开始处理请求: ${targetUrl}`);
        
        try {
            const cachedData = thumbnailCache.get(cacheKey);
            if (cachedData && (Date.now() - cachedData.timestamp) < 10000) {
                console.log(`[缩略图代理] 使用缓存数据: ${cacheKey}`);
                res.writeHead(200, {
                    'Content-Type': 'image/png',
                    'Content-Length': cachedData.data.length
                });
                return res.end(cachedData.data);
            }
            
            console.log(`[缩略图代理] 从主服务获取数据: ${targetUrl}`);
            const response = await fetch(targetUrl);
            
            if (!response.ok) {
                console.error(`[缩略图代理] 主服务返回错误: ${response.status} ${response.statusText}`);
                throw new Error(`主服务返回错误: ${response.status} ${response.statusText}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const buffer = new Uint8Array(arrayBuffer);
            
            if (buffer.length === 0) {
                console.error('[缩略图代理] 获取到的数据为空');
                throw new Error('获取到的数据为空');
            }
            
            console.log(`[缩略图代理] 成功获取数据: ${buffer.length} 字节`);
            thumbnailCache.set(cacheKey, {
                data: buffer,
                timestamp: Date.now()
            });
            
            res.writeHead(200, {
                'Content-Type': 'image/png',
                'Content-Length': buffer.length
            });
            res.end(buffer);
        } catch (error) {
            console.error('[缩略图代理] 处理请求失败:', error);
            res.status(500).send(`获取缩略图失败: ${error.message}`);
        }
    });
    
    app.listen(port, '127.0.0.1', () => {
        console.log(`服务器运行在 http://127.0.0.1:${port}`);
    })
    app.listen(port, 'localhost', () => {
        console.log(`静态图片服务运行在 http://localhost:${port}`);
    })
</script>