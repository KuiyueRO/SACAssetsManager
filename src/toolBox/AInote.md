# 这个区块的内容来自开发者,禁止AI未经允许修改

现在扫描所有utils等类似命名的文件夹,尝试进行重构

注意我们需要集中思源笔记的环境依赖,可以使用useSiyuan进行集中

由于一些原因项目中零散分布有一些工具文件,你也需要重构这些文件

对于外部依赖,当你发现一个node_modules中的依赖可能可以使用static中使用esm形式打包成静态文件时,你应该提出建议(但是不要修改,这一部分暂时由开发者处理)

注意项目中的**每一个**文件夹你都可以创建readme和AInote

有关重构的最终目标你可以查看项目根目录的index new.js

**已经完成的重构之后应该有一个倒数计数,每次计数为零时视为完成了一个阶段性重构,此时你应该总结当前的任务进度到history.md,不要让太多的细节干扰这个文件的框架**

**阶段计数是一个倒数进度,每次任务计划完成后需要减一,当减至零时表示完成一个阶段,此时应总结进度到history.md并重置计数**

**详细的历史记录应该只出现在history.md中,AInote.md只需要计数和简单提示,这个文件主要记录的是重构心得和要求而不是历史详情**

**先停止不断扩充工具箱,开始检查功能代码的实现**

# 工具箱重构笔记

## 工具箱结构概览

工具箱采用三层分类模块化设计，按功能域组织为不同子目录:

```
src/toolBox/
├── base/           - 基础工具函数
│   ├── useEcma/    - ECMA标准功能封装
│   │   ├── forFile/     - 文件操作相关工具
│   │   ├── forMath/     - 数学计算工具
│   │   ├── forString/   - 字符串处理工具 ✅
│   │   ├── textTools.js - 文本处理工具 ✅
│   │   └── ...
│   ├── forNetwork/  - 网络相关工具
│   │   ├── forFetch/     - fetch工具 ✅
│   │   ├── forPort/      - 端口工具 ✅
│   │   └── ...
│   ├── forEvent/    - 事件处理工具
│   ├── forMime/     - MIME类型处理
│   ├── forCore/     - 核心串链器工具
│   ├── forUI/       - 通用UI组件工具
│   ├── usePolyfills/ - 平台兼容性工具
│   │   ├── uaAnalysis.js - UA分析工具 ✅
│   │   └── ...
│   ├── useDeps/    - 依赖管理工具
│   │   ├── pinyinTools.js - 拼音工具 ✅
│   │   └── ...
│   └── ...
├── feature/        - 特定功能工具
│   ├── useImage/   - 图像处理工具
│   ├── useVue/     - Vue框架工具
│   ├── forFileSystem/ - 文件系统工具
│   └── ...
├── useAge/         - 使用场景相关工具
│   ├── forFileManage/    - 文件管理工具
│   ├── forSiyuan/        - 思源特定功能工具
│   │   ├── useSiyuanMenu.js    - 思源菜单工具 ✅
│   │   ├── useSiyuanDialog.js  - 思源对话框工具 ✅
│   │   ├── useSiyuanSystem.js  - 思源系统API ✅
│   │   └── ...
│   ├── useSiyuan.js      - 思源环境依赖集中管理 ✅
│   └── ...
├── toolBoxExports.js  - 统一导出接口
└── README.md       - 工具箱说明
```

## 已完成的重构(建议不要列举太多,隔一段时间总结一下,列出最近的动作就可以了)

阶段计数:2

当前正在进行第3阶段重构工作：实现siyuanCommon工具函数重构

详细历史记录请查看src/toolBox/history.md

## 重构原则

1. **最小改动**:
   - 创建兼容层以保持现有代码可用
   - 保留原函数名导出，添加中文命名版本

2. **函数式风格**:
   - 尽可能使用纯函数
   - 避免使用类，除非必要
   - 减少嵌套和副作用

3. **命名规范**:
   - 避免无语义的文件名(index.js, main.js)
   - 优先使用中文命名函数
   - 文件名应反映功能

4. **模块化设计**:
   - 按功能域组织工具
   - 相关功能放在同一目录
   - 文件过长时及时拆分

5. **依赖管理规范**:
   - useDeps 目录专门用于处理所有外部模块引用
   - 原则上任何外部模块不能被除了 useDeps 以外的文件直接引用
   - 需要使用外部模块的工具应当通过 useDeps 提供的封装接口进行调用
   - 所有外部依赖应在 useDeps 中进行集中管理和版本控制

## 后续重构计划

1. **待重构文件**:
   - `source/utils/time/` 目录下的时间处理工具
   - `source/utils/object/` 目录下的对象处理工具
   - `source/utils/` 目录下的其他工具函数
   - 继续完善 `useAge/forSiyuan/` 目录，迁移更多思源相关工具

2. **工具增强**:
   - 为更多工具函数添加单元测试
   - 补充JSDoc文档
   - 优化性能关键路径

## 注意事项

1. 所有重构应遵循"兼容、增强、替换"的三步走策略:
   - 先建立兼容层保证向后兼容
   - 在新位置增强功能
   - 最后逐步替换旧引用

2. 文件重构应该遵循:
   - 一次只处理少量文件
   - 每次改动应该可测试
   - 保留导入/导出兼容性

3. 代码规范:
   - 文件应尽可能精简，专注于单一职责
   - 优先使用命名导出而非默认导出
   - 同时提供中英文函数命名

## 已完成重构文件的增强

1. **文档增强**:
   - 所有重构文件都添加了完整的JSDoc注释
   - 为所有新文件添加了README.md说明文档

2. **API增强**:
   - 为所有函数添加了中英文双命名支持
   - 优化了函数参数和返回值的类型

3. **兼容性增强**:
   - 为所有已迁移文件创建了兼容层
   - 在原始位置添加了导入/重导出
   - 设置了弃用警告以指导开发者

## 最近完成的重构工作

参见src/toolBox/history.md中的历史记录

## 下一步重构计划

当前阶段3重点：siyuanCommon工具函数重构

详细重构计划请参考下方的详细计划部分以及history.md中的记录

## siyuanCommon工具函数重构详细计划

### 1. 斜杠菜单工具函数（useSiyuanSlash.js）
- 提取`slash.js`中以下函数：
  - `handleDialogDestroy` - 处理对话框销毁后的操作
  - `openDialogWithApiConfig` - 使用API配置打开对话框
  - `openDialogWithLocalPath` - 使用本地路径打开对话框
  - `openDiskSelectionDialog` - 打开磁盘选择对话框
  - `openEverythingDialog`和`openAnytxtDialog` - 搜索工具对话框
- 提供统一的斜杠菜单项注册接口
- 添加思源环境检查和错误处理

### 2. 对话框工具函数（useSiyuanDialog.js）
- 整合`dialog/vueDialog.js`中的`openDialog`函数
- 整合`dialog/inputDialog.js`中的输入对话框功能
- 整合`dialog/tasks.js`中的任务对话框功能
- 整合`dialog/fileDiffAndPick.js`中的文件对比和选择功能
- 提供统一的对话框创建和管理接口

### 3. 页签管理工具函数（useSiyuanTab.js）
- 从`tabs/assetsTab.js`提取以下函数：
  - `打开附件面板` - 打开资源面板
  - `打开笔记本资源视图` - 打开笔记本资源
  - `打开笔记资源视图` - 打开笔记资源
  - `打开标签资源视图` - 打开标签资源
  - `打开本地资源视图` - 打开本地资源
  - `打开efu文件视图页签` - 打开efu文件
  - `打开颜色资源视图` - 打开颜色资源
  - `打开everything搜索面板` - 打开搜索面板
  - `打开anytxt搜索面板` - 打开搜索面板
- 提供通用的页签创建和管理接口
- 添加页签状态监控和生命周期管理

### 4. 颜色工具函数（useSiyuanColor.js）
- 从`menus/galleryItem.js`中提取`颜色操作`相关函数：
  - `添加颜色操作菜单` - 添加颜色菜单
  - `创建颜色菜单项` - 创建颜色菜单项
  - `生成颜色子菜单` - 生成颜色子菜单
- 提供颜色提取、分析和操作的统一接口
- 添加颜色转换和调色板功能

### 5. 菜单构建工具函数（useSiyuanMenuBuilder.js）
- 从`menus/galleryItem.js`中提取`菜单构建`相关函数：
  - `添加附件选中信息` - 添加附件信息
  - `添加移动菜单` - 添加移动菜单
  - `添加批处理菜单组` - 添加批处理菜单
  - `添加只读菜单内容` - 添加只读菜单
  - `添加通用菜单内容` - 添加通用菜单
  - `添加展开的通用菜单` - 添加展开菜单
  - `添加折叠的通用菜单` - 添加折叠菜单
- 提供组合式菜单构建接口，支持菜单项的灵活组合
- 添加菜单项模板和预设

### 实施顺序和优先级
1. 先从功能相对独立的`useSiyuanSlash.js`和`useSiyuanTab.js`开始重构
2. 然后处理`useSiyuanDialog.js`的增强，整合对话框相关功能
3. 最后处理复杂的`useSiyuanMenuBuilder.js`和`useSiyuanColor.js`

这些重构将使思源笔记的环境依赖更加集中，通过`useSiyuan`系列模块提供统一的接口，提高代码的可维护性和可重用性。


