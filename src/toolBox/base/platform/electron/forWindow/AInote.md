# Electron 窗口模块设计说明

## 模块结构

此模块采用了函数式编程风格，将 Electron 窗口管理功能拆分为多个专门的子模块：

1. **useBrowserWindow.js** - 主模块，提供创建浏览器窗口的入口函数
2. **browserWindowCore.js** - 核心功能，提供配置管理和参数验证
3. **browserWindowManagement.js** - 窗口管理功能，负责创建、关闭和单实例处理
4. **windowPersistence.js** - 窗口持久化功能，确保窗口保持活跃
5. **windowHeartbeat.js** - 心跳检测功能，监控窗口状态并自动恢复

## 设计原则

1. **职责分离**: 每个文件处理一类相关功能
2. **函数式风格**: 使用纯函数减少副作用
3. **易扩展**: 通过合理的模块划分，方便未来功能扩展
4. **可测试**: 独立的功能函数更易于单元测试

## 使用说明

主要通过 `创建浏览器窗口` 函数创建和管理 Electron 窗口，通过配置对象控制窗口的行为。

```javascript
创建浏览器窗口('https://example.com', {
  单实例: true,
  保持活跃: true,
  使用心跳检测: true
});
```

## readme.md

```markdown:src/toolBox/base/useElectron/forWindow/readme.md
# Electron 窗口管理工具

## 功能简介

这个工具提供了创建和管理 Electron 浏览器窗口的功能，支持：

- 窗口单实例控制
- 窗口持久化（自动重建）
- 窗口心跳检测
- 窗口缓存清理

## 使用示例

```javascript
import { 创建浏览器窗口 } from './useBrowserWindow.js';

// 基本用法
创建浏览器窗口('https://example.com');

// 高级配置
创建浏览器窗口('https://example.com', {
  单实例: true,         // 确保只有一个窗口实例
  保持活跃: true,       // 窗口关闭后自动重建
  使用心跳检测: true,   // 使用心跳检测确保窗口响应
  清除缓存: true,       // 清除浏览器缓存
  显示标题栏: false,    // 隐藏窗口标题栏
  立即显示: true        // 窗口创建后立即显示
});
```

## 配置选项

| 选项 | 默认值 | 说明 |
|------|--------|------|
| 关闭已有窗口 | true | 是否关闭已存在的相同URL窗口 |
| 单实例 | true | 是否确保只有一个窗口实例 |
| 立即显示 | true | 是否立即显示窗口 |
| 清除缓存 | true | 是否清除浏览器缓存 |
| 保持活跃 | true | 窗口关闭时是否自动重新创建 |
| 使用心跳检测 | true | 是否启用心跳检测 |
| 显示标题栏 | true | 是否显示窗口标题栏 |
| 获取同源窗口函数 | null | 用于查找同源窗口的函数 |
| enableRemote | null | 自定义的enableRemote函数 |
```

## 总结

通过这种拆分方式，原本过长的单一文件被拆分成了5个功能明确的小模块：
1. 主模块 - 提供API入口
2. 核心功能 - 提供基础配置
3. 窗口管理 - 处理窗口实例
4. 窗口持久化 - 保持窗口活跃
5. 心跳检测 - 监控窗口状态

每个模块都有明确的职责和适当的功能分组，使代码更易于理解和维护。同时保持了函数式编程风格，减少了函数嵌套。 
```

# 窗口持久化功能说明

## 功能概述

本模块提供Electron窗口的持久化管理，使窗口在关闭后能够自动重建，确保应用的关键窗口始终可用。

## 实现原理

窗口持久化功能主要通过以下机制实现：

1. **监听窗口关闭事件**：当窗口关闭时触发重建逻辑
2. **窗口重建计数**：使用Map结构记录窗口重建次数，防止无限循环创建
3. **最大重建次数限制**：设置最大重建次数阈值，超过后停止自动重建
4. **用户确认机制**：达到一定重建次数后请求用户确认再继续重建
5. **计数器重置机制**：一段时间后自动重置计数器，允许后续重新开始计数

## 防止无限循环的机制

为了防止窗口在关闭后无限循环创建，我们实现了以下保护机制：

1. 每个窗口有唯一标识符，基于URL和创建时间戳
2. 对每个窗口标识维护一个重建计数器
3. 当重建次数达到确认阈值（默认为2次）时，向用户请求确认
4. 当计数达到预设的最大值（默认为3次）时，停止自动重建
5. 计数器会在一段时间后（默认为1分钟）自动重置，防止长期禁用重建功能
6. 重建窗口时添加短暂延时，避免即时重建可能带来的性能问题

## 用户确认对话框

在窗口重建达到确认阈值次数后，系统会显示一个确认对话框，询问用户是否继续重建窗口：

- 如果用户选择"重建窗口"，窗口将继续重建
- 如果用户选择"关闭窗口"，将停止自动重建流程

这有效防止了无人值守情况下可能出现的无限重建循环。

## 使用方法

使用`创建浏览器窗口`函数时，可以通过`保持活跃`参数控制是否启用此功能：

```javascript
import { 创建浏览器窗口 } from './useBrowserWindow.js';

// 创建一个会自动重建的窗口
const 窗口 = 创建浏览器窗口('app://example.html', { 
  保持活跃: true, 
  // 其他窗口配置...
});

// 创建一个不会自动重建的窗口
const 普通窗口 = 创建浏览器窗口('app://example2.html', { 
  保持活跃: false 
});
```

## 配置参数

可以通过修改以下常量来调整持久化行为：

- `最大重建次数`：允许的最大重建次数，默认为3
- `确认重建阈值`：需要用户确认的重建次数阈值，默认为2
- `重置计数器超时`：计数器重置的时间（毫秒），默认为60000（1分钟）
