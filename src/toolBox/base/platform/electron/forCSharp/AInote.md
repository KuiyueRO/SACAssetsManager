# C#与Electron交互模块设计笔记

## 模块概述

`useCSharpLoader.js`模块提供了在Electron环境中加载和执行C#代码的功能，是对`electron-edge-js`库的封装和增强。该模块通过将回调风格的API转换为Promise风格，并提供了自动并行处理能力，使C#代码能够高效地在Electron应用中运行。

## 核心设计原则

1. **函数式设计**：采用纯函数风格，每个函数专注于单一职责
2. **自动并行**：根据CPU核心数自动并行处理C#函数调用
3. **错误处理**：提供全面的错误捕获和处理机制
4. **路径兼容性**：解决Windows下非ASCII字符路径问题

## 代码结构

模块拆分为以下几个功能组：

### 1. 通用工具函数

- `创建回调Promise`：将回调风格API转换为Promise风格
- `初始化环境`：懒加载CPU核心数等环境配置
- `加载Edge模块`：安全加载electron-edge-js模块

### 2. C#函数加载模块

- `获取函数实例列表`：管理C#函数实例
- `执行现有函数实例`：执行已加载的函数实例
- `创建并执行新函数实例`：创建并执行新的函数实例
- `加载C井函数`：从代码字符串加载C#函数
- `加载C井文件`：从文件加载C#函数

### 3. 文件操作模块

- `加载文件所需模块`：加载文件操作所需的模块
- `读取文件内容`：安全读取文件内容

### 4. DLL路径处理模块

- `检查思源配置`：检查思源笔记配置
- `获取DLL路径`：计算DLL路径
- `确保目录存在`：确保目录存在
- `复制DLL文件`：复制DLL文件
- `设置DLL路径`：设置DLL路径，解决非ASCII字符路径问题

## 性能优化

1. **实例复用**：复用已创建的C#函数实例，避免重复创建
2. **并行处理**：根据CPU核心数自动创建多个函数实例进行并行处理
3. **懒加载**：环境配置和模块加载采用懒加载方式

## 重构思路

原有代码存在以下问题：

1. `加载C井函数`函数过长且责任不清晰
2. `加载C井文件`和`设置DLL路径`函数也较长
3. 代码中存在重复的错误处理逻辑

重构时采用的策略：

1. **函数拆分**：将长函数拆分为多个专注于单一职责的小函数
2. **关注点分离**：将函数初始化、执行和错误处理分离
3. **提取公共逻辑**：将重复的错误处理逻辑提取为独立函数

## 使用建议

1. 优先使用`加载C井函数`而不是`加载C井文件`，因为前者提供了自动并行处理能力
2. 在Windows环境下，总是在使用前调用`设置DLL路径`函数
3. 处理大量数据时，尽量批量处理，以充分利用并行能力
4. 异常处理应在调用C#函数时进行，而不是依赖模块内部的错误处理

## 未来改进方向

1. 添加函数实例池管理，更好地控制资源使用
2. 提供更细粒度的并行控制选项
3. 增强与.NET类型的互操作能力
4. 添加性能监控和日志功能 