# 空闲队列处理器模块设计笔记

## 模块概述

本模块提供基于浏览器 `requestIdleCallback` API 的空闲时间任务处理工具，主要用于执行非紧急但可能耗时的操作，避免阻塞主线程，提高用户体验。

## 设计决策

1. **函数命名规范**：
   - 采用 `use*` 前缀表示资源使用
   - 提供中英文双语API，便于不同开发者使用

2. **错误处理**：
   - 添加错误捕获和报告机制
   - 提供超时保护，避免任务长时间未执行

3. **取消机制**：
   - 返回取消函数，允许随时终止任务
   - 清理相关资源，避免内存泄漏

4. **避免递归调用**：
   - 使用 `setTimeout` 替代直接递归，避免调用栈溢出

5. **优先级队列**：
   - 实现基于优先级的任务调度，确保关键任务先执行
   - 支持动态添加和取消任务

6. **并发控制**：
   - 通过参数控制最大并发任务数
   - 避免过多任务同时执行导致性能问题

## 重构过程

1. 原始代码存在的问题：
   - 函数命名不规范（`idleIdle` 和 `$idleIdle`）
   - 递归实现可能导致调用栈溢出
   - 缺乏错误处理和超时保护
   - 没有取消机制和资源清理

2. 重构改进：
   - 规范化命名为 `useIdleTask` 和 `useIdleCallback`
   - 添加错误处理和超时保护
   - 实现取消机制和资源清理
   - 避免递归调用
   - 增加优先级队列和并发控制功能

3. 文件组织：
   - `useIdleQueue.js`：核心实现文件
   - `idleQueueTools.js`：统一导出接口
   - `README.md`：使用文档
   - `AInote.md`：设计笔记

## 兼容性考虑

1. 浏览器支持：
   - 添加 `isIdleCallbackSupported` 函数检测环境支持情况
   - 考虑后续添加 polyfill 支持

2. 性能优化：
   - 使用 Promise 异步处理任务结果
   - 任务按优先级排序，确保关键任务优先执行
   - 超时保护避免资源浪费

## 使用场景

1. 大量数据处理和计算
2. 非关键UI更新
3. 数据同步和日志记录
4. 预加载和缓存操作
5. 性能监控和分析

## 未来改进方向

1. 添加 `requestIdleCallback` polyfill
2. 支持任务分片执行
3. 实现任务进度跟踪
4. 增加基于时间片的任务调度
5. 支持任务依赖关系处理 