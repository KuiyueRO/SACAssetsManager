# DeltaPQ向量压缩与检索模块

本模块实现了高性能的DeltaPQ (Delta Product Quantization) 向量压缩与检索算法，采用函数式编程风格。它能够大幅减少向量存储空间，同时保持近似搜索的准确性。

## 原理与实现

DeltaPQ算法核心原理：
1. **中心向量提取** - 计算所有向量的中心，将向量表示为相对于中心的偏差(Delta)
2. **子空间划分** - 将向量空间划分为多个子空间
3. **量化编码** - 对每个子空间进行聚类，用聚类中心ID替代原始向量数据
4. **索引检索** - 基于量化编码快速计算近似距离

这种方法相比原始向量存储有以下优势：
- 大幅减少存储空间（通常为原始大小的1/32至1/16）
- 加速向量距离计算
- 允许内存中存储更大规模的向量集合

## 多距离度量支持

模块现在支持多种距离度量方法：

- **欧几里得距离** (L2距离) - 适用于一般场景，直观的几何距离
- **曼哈顿距离** (L1距离) - 适用于稀疏特征，减少离群值影响
- **切比雪夫距离** (L∞距离) - 适用于需要考虑最大差异的场景
- **余弦距离** - 适用于方向相似性，忽略大小差异
- **内积距离** - 适用于已归一化的向量相似度计算

距离度量选择指南：
- 如果向量表示语义特征，推荐使用余弦距离
- 如果向量表示物理特征，推荐使用欧几里得距离
- 如果数据维度非常高且稀疏，可以考虑曼哈顿距离
- 如果向量已归一化，内积距离计算速度最快

## 优化方法

模块中应用了多种优化方法：

1. **距离计算优化**
   - 针对每种距离函数的特定优化
   - 向量比较前进行维度一致性检查
   - 避免重复计算

2. **量化过程优化**
   - k-means++初始化提高聚类质量
   - 向量分解与子空间处理的性能优化
   - 内存缓冲区复用减少内存分配

3. **错误处理与稳定性**
   - 防御性编程确保各种边缘情况处理
   - 无效数据自动过滤与正规化
   - 详细日志记录方便调试

## 序列化支持

DeltaPQ模型支持完整的序列化与反序列化：
- 可保存训练好的模型到JSON字符串
- 可从序列化数据恢复模型状态
- 包含版本与完整性检查

## 使用场景

该模块特别适合：
- 大规模向量集合的高效存储
- 近似最近邻搜索
- 需要在有限内存中处理大量高维向量的应用
- 作为HNSW等图索引的前置压缩器

## 性能特点

- 空间复杂度：O(n/c + c)，其中c为压缩率
- 量化训练时间：O(n·d·k·i)，其中n为向量数量，d为维度，k为聚类数，i为迭代次数
- 量化查询时间：O(d·k)
- 常见压缩率：1/16至1/32不等，依赖于配置参数

## 技术挑战与解决方案

1. **量化误差控制**
   - 通过增加子向量数量减少量化误差
   - 自适应调整子空间大小
   - 训练时使用代表性样本

2. **处理不同距离度量的特殊性**
   - 对于内积距离，确保向量已归一化
   - 对于余弦距离，转换为基于欧氏距离的计算
   - 对于非欧氏距离，子空间距离累加逻辑需特殊处理

3. **边缘情况处理**
   - 零向量与极小值特殊处理
   - 不同维度向量兼容处理
   - 训练数据不足时的备选策略

## 优化方向

1. 增加更多距离函数支持，如Jaccard距离等
2. 实现带权重的距离计算
3. 向量预处理与标准化自动化
4. 针对不同硬件架构的性能优化
5. 增强训练样本选择策略 