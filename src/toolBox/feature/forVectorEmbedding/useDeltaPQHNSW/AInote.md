# HNSW索引实现与调试笔记

## 性能优化与问题排查

### ID匹配问题排查

召回率始终为0的核心问题通常与ID映射有关。HNSW索引内部使用自增ID，而测试数据使用原始ID，这两者需要正确映射：

1. 确保向量插入索引时，原始ID被保存在节点的metadata中
2. 在搜索结果返回时，应该返回原始ID而不是内部节点ID
3. 测试验证时，需要确保精确搜索和HNSW搜索返回的ID格式一致

### 常见问题解决

1. **召回率低问题**
   - 增大efSearch参数 (200以上)
   - 确保M参数足够大 (32-64)
   - 底层实现双向连接以提高图连通性
   
2. **ID映射问题**
   - 在节点metadata中明确保存原始ID
   - 搜索结果处理时返回原始ID
   - 保持精确搜索和HNSW搜索使用相同的ID格式

3. **向量规范化**
   - 使用余弦距离时，确保向量已规范化
   - 对于欧氏距离，确保向量维度和数值范围一致

## 优化方向

1. 增加距离计算缓存，减少重复计算
2. 底层节点加入更多双向连接，提高召回率
3. 在查询时使用更大的ef值
4. 针对底层实现更密集的连接结构 