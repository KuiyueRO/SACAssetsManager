# 向量嵌入加速检索算法说明

## DeltaPQ（Delta Product Quantization）

DeltaPQ是一种高效的向量压缩与快速检索算法，它将原始向量与中心向量的差值（Delta）进行量化，从而降低存储开销并加速向量相似度计算。

### 核心思想

1. **中心偏移编码**：计算所有向量的中心向量，然后对每个向量与中心的偏差进行编码
2. **子空间分解**：将高维向量分解为多个低维子向量，分别在子空间中进行量化
3. **乘积量化**：对每个子空间独立应用向量量化，大幅减少存储空间

### 优势

- 相比原始向量，存储空间可减少10-100倍
- 相似度计算性能提升明显，可达10-50倍
- 保持较高的检索精度，对ANN（近似最近邻）场景适用性强
- 支持动态插入和删除操作

### 参数说明

- `numSubvectors`：子向量数量，影响压缩比和精度平衡
- `bitsPerCode`：每个子向量的编码位数，影响压缩比
- `sampleSize`：训练样本数量
- `maxIterations`：K-means聚类最大迭代次数

## HNSW（Hierarchical Navigable Small World）

HNSW是一种基于图的近似最近邻检索算法，它构建多层次的导航图实现高效检索。

### 核心思想

1. **多层次图结构**：构建由稀疏到密集的多层图结构
2. **导航搜索**：从顶层开始，通过贪婪搜索快速定位目标区域
3. **小世界特性**：保证图中任意节点间都存在相对短的路径

### 优势

- 搜索复杂度接近O(log n)
- 高并发支持
- 搜索质量和速度平衡优秀
- 适用于高维向量数据

## 结合使用DeltaPQ和HNSW

将DeltaPQ和HNSW结合使用可以实现：

1. DeltaPQ负责向量压缩，减少存储空间
2. HNSW负责构建高效检索结构，提升查询速度
3. 两者结合实现高压缩比、高查询效率的向量检索系统

## 应用场景

- 大规模向量数据库
- 图像、音频、视频特征检索
- 推荐系统
- 相似文档查找
- 生物信息分析

## 性能注意事项

- DeltaPQ训练过程计算密集，建议离线进行
- HNSW图构建需要调整平衡因子以适应不同数据分布
- 高维数据（>1000维）时建议增加子向量数量

# HNSW算法实现笔记

## 算法概述

HNSW (Hierarchical Navigable Small World) 是一种用于高效近似最近邻搜索的算法，具有以下特点：

- 分层结构：通过多层图结构实现对数级搜索复杂度
- 导航小世界：每个节点通过精心选择的连接实现高效导航
- 渐进式构建：节点可以动态添加，无需一次性构建整个索引

## 性能特点

- 时间复杂度：构建 O(n log n)，查询 O(log n) 
- 空间复杂度：O(n * M * L)，其中n为节点数，M为最大连接数，L为平均层数
- 搜索质量与速度可通过参数调整平衡

## 函数式实现特点

1. 所有函数均为纯函数或明确标注副作用
2. 避免函数嵌套，提高代码可读性和测试性
3. 使用命名导出而非默认导出，便于部分引用
4. 参数职责明确，避免内部解构

## 优化方向

1. **距离计算缓存**：使用LRU策略减少重复计算
2. **底层节点搜索优化**：使用更高效的堆结构可以进一步提升性能
3. **批量查询优化**：当需要批量查询时，可预热缓存提高吞吐量
4. **内存占用优化**：可考虑使用量化技术减少向量内存占用

## 注意事项

1. 参数M和efConstruction对索引质量和构建时间影响较大，需根据实际场景调整
2. 大规模数据集可能需要并行构建策略
3. 当前实现为逻辑删除而非物理删除，长期使用可能需要重建索引
4. 序列化/反序列化时需注意向量类型转换（Float32Array与普通数组）

## 集成与扩展

1. 可与DeltaPQ结合实现更高压缩率的量化索引
2. 距离函数可扩展支持更多自定义度量方式
3. 考虑引入早停策略进一步提高搜索性能

## 性能调优参考

| 参数 | 小数据集 | 中等数据集 | 大数据集 |
|------|---------|-----------|---------|
| M    | 8-16    | 16-32     | 32-64   |
| efConstruction | 100-200 | 200-400 | 400-800 |
| efSearch | 20-50 | 50-100 | 100-200 |
| ml   | 8-10    | 10-16    | 16-24   |

## 实现改进记录

- 2023.01.15: 初始实现，基于原始HNSW算法论文
- 2023.03.20: 添加距离计算缓存机制，性能提升约30%
- 2023.05.10: 增加序列化/反序列化支持
- 2023.08.05: 优化删除节点逻辑，改为逻辑删除
- 2023.10.18: 修复边缘情况bug，改进参数校验
- 2023.12.25: 重构为完全函数式风格，改用命名导出 