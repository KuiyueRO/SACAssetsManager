# HNSW (Hierarchical Navigable Small World) 索引算法

## 基本原理

HNSW是一种基于图的算法，用于解决高维空间中的K近邻(KNN)搜索问题。它的核心思想是构建一个多层次的导航图，通过在不同层次的图上进行快速导航来加速搜索过程。相比传统的KD树、VP树等方法，HNSW在高维空间中表现出色。

### 主要特性

1. **层次结构**：HNSW使用分层结构，顶层包含少量节点，底层包含所有节点。
2. **跳表思想**：类似于跳表，高层用于快速定位到大致区域，低层用于精确搜索。
3. **小世界图**：每层构建一个小世界图，节点连接到其邻居，形成高效导航网络。
4. **贪婪搜索**：在查询时通过贪婪算法快速定位到目标区域。

## 时间复杂度

- 构建：O(n·log(n)^2)
- 查询：O(log(n))

这使HNSW成为处理大规模高维数据集的理想选择。

## 实现细节

本实现是基于Rust的horaHnsw.rs的JavaScript翻译，具有以下主要组件：

1. **二进制堆**：用于维护候选项的优先队列
2. **Neighbor类**：表示节点之间的关系及距离
3. **FixedBitSet**：用于跟踪已访问节点
4. **多种距离度量**：支持欧氏距离、余弦距离、曼哈顿距离和点积

### 关键参数

- `max_level`：最大层数
- `n_neighbor/n_neighbor0`：每个节点在各层的最大邻居数
- `ef_build/ef_search`：构建/搜索时的候选集大小

## 核心算法

1. **构建**：
   - 插入时为节点随机分配层级
   - 从顶层开始向下搜索最近邻
   - 在每层使用启发式算法连接邻居

2. **搜索**：
   - 从顶层入口点开始，贪婪寻找更近的点
   - 下降到每一层，扩大搜索范围
   - 在底层进行精确搜索，返回K个最近邻

## 优化特性

1. 支持向量序列化/反序列化，便于持久化
2. 支持节点删除（标记删除）
3. 高效的邻居启发式选择算法
4. 内存和性能之间的可调节平衡

## 使用指南

```js
// 创建索引
const index = new HNSWIndex(dimension, {
  n_neighbor: 32,
  ef_search: 400
});

// 添加数据
for (const vector of vectors) {
  index.addNode(new Node(vector, id));
}

// 构建索引
index.build(Metric.Cosine);

// 搜索
const results = index.nodeSearchK(queryVector, 10);
```

## 注意事项

- 索引构建是耗时操作，适合离线构建
- 内存占用随节点数和维度增加而增加
- 参数调优对性能和准确性有显著影响 