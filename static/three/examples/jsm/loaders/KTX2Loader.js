/* esm.sh - esbuild bundle(three@0.169.0/examples/jsm/loaders/KTX2Loader) es2022 production */
import{CompressedTexture as te,CompressedArrayTexture as Ce,CompressedCubeTexture as Ae,Data3DTexture as Ee,DataTexture as Be,DisplayP3ColorSpace as ge,FileLoader as M,FloatType as G,HalfFloatType as x,NoColorSpace as Z,LinearFilter as Q,LinearMipmapLinearFilter as we,LinearDisplayP3ColorSpace as Pe,LinearSRGBColorSpace as xe,Loader as ye,RedFormat as y,RGB_ETC1_Format as Le,RGB_ETC2_Format as Ge,RGB_PVRTC_4BPPV1_Format as Oe,RGBA_ASTC_4x4_Format as re,RGBA_ASTC_6x6_Format as $,RGBA_BPTC_Format as Ue,RGBA_ETC2_EAC_Format as Me,RGBA_PVRTC_4BPPV1_Format as Ke,RGBA_S3TC_DXT5_Format as be,RGBA_S3TC_DXT1_Format as De,RGBAFormat as g,RGFormat as L,SRGBColorSpace as ke,UnsignedByteType as T}from"../../../three.mjs";import{WorkerPool as He}from"../../../examples/jsm/utils/WorkerPool.js";import{read as Ie,KHR_DF_FLAG_ALPHA_PREMULTIPLIED as Ve,KHR_DF_TRANSFER_SRGB as q,KHR_SUPERCOMPRESSION_NONE as ve,KHR_SUPERCOMPRESSION_ZSTD as ee,VK_FORMAT_UNDEFINED as We,VK_FORMAT_R16_SFLOAT as oe,VK_FORMAT_R16G16_SFLOAT as se,VK_FORMAT_R16G16B16A16_SFLOAT as ae,VK_FORMAT_R32_SFLOAT as ie,VK_FORMAT_R32G32_SFLOAT as ne,VK_FORMAT_R32G32B32A32_SFLOAT as ce,VK_FORMAT_R8_SRGB as pe,VK_FORMAT_R8_UNORM as _e,VK_FORMAT_R8G8_SRGB as de,VK_FORMAT_R8G8_UNORM as le,VK_FORMAT_R8G8B8A8_SRGB as Te,VK_FORMAT_R8G8B8A8_UNORM as ue,VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT as me,VK_FORMAT_ASTC_6x6_SRGB_BLOCK as he,VK_FORMAT_ASTC_6x6_UNORM_BLOCK as Re,KHR_DF_PRIMARIES_UNSPECIFIED as Ne,KHR_DF_PRIMARIES_BT709 as Xe,KHR_DF_PRIMARIES_DISPLAYP3 as je}from"../../../examples/jsm/libs/ktx-parse.module.js";import{ZSTDDecoder as ze}from"../../../examples/jsm/libs/zstddec.module.js";var K=new WeakMap,b=0,D,w=class a extends ye{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new He,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return e.isWebGPURenderer===!0?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){let e=new M(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);let c=e.loadAsync("basis_transcoder.js"),t=new M(this.manager);t.setPath(this.transcoderPath),t.setResponseType("arraybuffer"),t.setWithCredentials(this.withCredentials);let o=t.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([c,o]).then(([r,_])=>{let R=a.BasisWorker.toString(),S=["/* constants */","let _EngineFormat = "+JSON.stringify(a.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(a.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(a.BasisFormat),"/* basis_transcoder.js */",r,"/* worker */",R.substring(R.indexOf("{")+1,R.lastIndexOf("}"))].join(`
    `);this.workerSourceURL=URL.createObjectURL(new Blob([S])),this.transcoderBinary=_,this.workerPool.setWorkerCreator(()=>{let u=new Worker(this.workerSourceURL),i=this.transcoderBinary.slice(0);return u.postMessage({type:"init",config:this.workerConfig,transcoderBinary:i},[i]),u})}),b>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),b++}return this.transcoderPending}load(e,c,t,o){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");let r=new M(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),r.load(e,_=>{this.parse(_,c,o)},t,o)}parse(e,c,t){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(K.has(e))return K.get(e).promise.then(c).catch(t);this._createTexture(e).then(o=>c?c(o):null).catch(t)}_createTextureFrom(e,c){let{faces:t,width:o,height:r,format:_,type:R,error:S,dfdFlags:u}=e;if(R==="error")return Promise.reject(S);let i;if(c.faceCount===6)i=new Ae(t,_,T);else{let F=t[0].mipmaps;i=c.layerCount>1?new Ce(F,o,r,c.layerCount,_,T):new te(F,o,r,_,T)}return i.minFilter=t[0].mipmaps.length===1?Q:we,i.magFilter=Q,i.generateMipmaps=!1,i.needsUpdate=!0,i.colorSpace=Fe(c),i.premultiplyAlpha=!!(u&Ve),i}async _createTexture(e,c={}){let t=Ie(new Uint8Array(e));if(t.vkFormat!==We)return Je(t);let o=c,r=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:o},[e])).then(_=>this._createTextureFrom(_.data,t));return K.set(e,{promise:r}),r}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),b--,this}};w.BasisFormat={ETC1S:0,UASTC_4x4:1};w.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16};w.EngineFormat={RGBAFormat:g,RGBA_ASTC_4x4_Format:re,RGBA_BPTC_Format:Ue,RGBA_ETC2_EAC_Format:Me,RGBA_PVRTC_4BPPV1_Format:Ke,RGBA_S3TC_DXT5_Format:be,RGB_ETC1_Format:Le,RGB_ETC2_Format:Ge,RGB_PVRTC_4BPPV1_Format:Oe,RGBA_S3TC_DXT1_Format:De};w.BasisWorker=function(){let a,e,c,t=_EngineFormat,o=_TranscoderFormat,r=_BasisFormat;self.addEventListener("message",function(n){let s=n.data;switch(s.type){case"init":a=s.config,_(s.transcoderBinary);break;case"transcode":e.then(()=>{try{let{faces:l,buffers:m,width:p,height:d,hasAlpha:C,format:f,dfdFlags:h}=R(s.buffer);self.postMessage({type:"transcode",id:s.id,faces:l,width:p,height:d,hasAlpha:C,format:f,dfdFlags:h},m)}catch(l){console.error(l),self.postMessage({type:"error",id:s.id,error:l.message})}});break}});function _(n){e=new Promise(s=>{c={wasmBinary:n,onRuntimeInitialized:s},BASIS(c)}).then(()=>{c.initializeBasis(),c.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function R(n){let s=new c.KTX2File(new Uint8Array(n));function l(){s.close(),s.delete()}if(!s.isValid())throw l(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let m=s.isUASTC()?r.UASTC_4x4:r.ETC1S,p=s.getWidth(),d=s.getHeight(),C=s.getLayers()||1,f=s.getLevels(),h=s.getFaces(),V=s.getHasAlpha(),Se=s.getDFDFlags(),{transcoderFormat:v,engineFormat:W}=F(m,p,d,V);if(!p||!d||!f)throw l(),new Error("THREE.KTX2Loader:	Invalid texture");if(!s.startTranscoding())throw l(),new Error("THREE.KTX2Loader: .startTranscoding failed");let N=[],X=[];for(let P=0;P<h;P++){let j=[];for(let A=0;A<f;A++){let z=[],O,U;for(let E=0;E<C;E++){let B=s.getImageLevelInfo(A,E,P);P===0&&A===0&&E===0&&(B.origWidth%4!==0||B.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),f>1?(O=B.origWidth,U=B.origHeight):(O=B.width,U=B.height);let J=new Uint8Array(s.getImageTranscodedSizeInBytes(A,E,0,v));if(!s.transcodeImage(J,A,E,P,v,0,-1,-1))throw l(),new Error("THREE.KTX2Loader: .transcodeImage failed.");z.push(J)}let Y=fe(z);j.push({data:Y,width:O,height:U}),X.push(Y.buffer)}N.push({mipmaps:j,width:p,height:d,format:W})}return l(),{faces:N,buffers:X,width:p,height:d,hasAlpha:V,format:W,dfdFlags:Se}}let S=[{if:"astcSupported",basisFormat:[r.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[t.RGBA_ASTC_4x4_Format,t.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[t.RGBA_BPTC_Format,t.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[t.RGBA_S3TC_DXT1_Format,t.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[t.RGB_ETC2_Format,t.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[o.ETC1],engineFormat:[t.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[t.RGB_PVRTC_4BPPV1_Format,t.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],u=S.sort(function(n,s){return n.priorityETC1S-s.priorityETC1S}),i=S.sort(function(n,s){return n.priorityUASTC-s.priorityUASTC});function F(n,s,l,m){let p,d,C=n===r.ETC1S?u:i;for(let f=0;f<C.length;f++){let h=C[f];if(a[h.if]&&h.basisFormat.includes(n)&&!(m&&h.transcoderFormat.length<2)&&!(h.needsPowerOfTwo&&!(I(s)&&I(l))))return p=h.transcoderFormat[m?1:0],d=h.engineFormat[m?1:0],{transcoderFormat:p,engineFormat:d}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),p=o.RGBA32,d=t.RGBAFormat,{transcoderFormat:p,engineFormat:d}}function I(n){return n<=2?!0:(n&n-1)===0&&n!==0}function fe(n){if(n.length===1)return n[0];let s=0;for(let p=0;p<n.length;p++){let d=n[p];s+=d.byteLength}let l=new Uint8Array(s),m=0;for(let p=0;p<n.length;p++){let d=n[p];l.set(d,m),m+=d.byteLength}return l}};var Ye=new Set([g,L,y]),k={[ce]:g,[ae]:g,[ue]:g,[Te]:g,[ne]:L,[se]:L,[le]:L,[de]:L,[ie]:y,[oe]:y,[pe]:y,[_e]:y,[me]:re,[he]:$,[Re]:$},H={[ce]:G,[ae]:x,[ue]:T,[Te]:T,[ne]:G,[se]:x,[le]:T,[de]:T,[ie]:G,[oe]:x,[pe]:T,[_e]:T,[me]:x,[he]:T,[Re]:T};async function Je(a){let{vkFormat:e}=a;if(k[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let c;a.supercompressionScheme===ee&&(D||(D=new Promise(async r=>{let _=new ze;await _.init(),r(_)})),c=await D);let t=[];for(let r=0;r<a.levels.length;r++){let _=Math.max(1,a.pixelWidth>>r),R=Math.max(1,a.pixelHeight>>r),S=a.pixelDepth?Math.max(1,a.pixelDepth>>r):0,u=a.levels[r],i;if(a.supercompressionScheme===ve)i=u.levelData;else if(a.supercompressionScheme===ee)i=c.decode(u.levelData,u.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let F;H[e]===G?F=new Float32Array(i.buffer,i.byteOffset,i.byteLength/Float32Array.BYTES_PER_ELEMENT):H[e]===x?F=new Uint16Array(i.buffer,i.byteOffset,i.byteLength/Uint16Array.BYTES_PER_ELEMENT):F=i,t.push({data:F,width:_,height:R,depth:S})}let o;if(Ye.has(k[e]))o=a.pixelDepth===0?new Be(t[0].data,a.pixelWidth,a.pixelHeight):new Ee(t[0].data,a.pixelWidth,a.pixelHeight,a.pixelDepth);else{if(a.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");o=new te(t,a.pixelWidth,a.pixelHeight)}return o.mipmaps=t,o.type=H[e],o.format=k[e],o.colorSpace=Fe(a),o.needsUpdate=!0,Promise.resolve(o)}function Fe(a){let e=a.dataFormatDescriptor[0];return e.colorPrimaries===Xe?e.transferFunction===q?ke:xe:e.colorPrimaries===je?e.transferFunction===q?ge:Pe:e.colorPrimaries===Ne?Z:(console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),Z)}export{w as KTX2Loader};
    //# sourceMappingURL=KTX2Loader.js.map