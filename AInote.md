# 本部分由开发者编写,未经允许禁止AI助手更改

目前的重点是/src/toolbox和/src/shared的构建,分散于项目各处的通用公共工具函数应该被重构到这两个位置
注意这两个模块之间的区别

# 思源笔记资源管理插件重构计划

## 重构概述

本文档描述了思源笔记资源管理插件(SACAssetsManager)的整体重构计划。该插件正在从旧的架构迁移到新的组织结构，以提高代码质量、可维护性和性能。

## 目录结构迁移

旧结构(`source/`)到新结构(`src/`)的映射关系：

| 旧目录/文件 | 新目录/文件 | 状态 | 优先级 | 备注 |
|------------|------------|------|-------|------|
| source/UI/ | src/components/ | 进行中 | 高 | UI组件和界面 |
| source/utils/ | src/toolBox/ | 进行中 | 高 | 工具函数库 |
| source/server/ | src/services/ | 待开始 | 高 | 服务器和API |
| source/events/ | src/events/ | 进行中 | 高 | 事件系统 |
| source/shared/ | src/shared/ | 待开始 | 中 | 共享资源 |
| source/servicies/ | src/services/ | 待开始 | 高 | 服务层 |
| source/triggers/ | src/middlewares/ | 待开始 | 中 | 触发器和中间件 |
| source/polyfills/ | src/toolBox/base/usePolyfills/ | 完成 | 高 | 兼容性填充 |
| index.js | src/index.js | 待开始 | 高 | 主入口文件 |

## 重构原则

1. **模块化设计**：
   - 按功能域划分模块
   - 明确模块边界和责任
   - 减少模块间耦合

2. **代码标准化**：
   - 统一命名规范（中文函数名）
   - 统一代码风格
   - 使用函数式编程风格
   - 减少类的使用

3. **性能优化**：
   - 减少不必要的计算
   - 优化资源加载
   - 实现惰性加载和按需执行

4. **增强可测试性**：
   - 编写单元测试
   - 实现功能隔离
   - 减少副作用

5. **保持兼容性**：
   - 提供向后兼容接口
   - 渐进式迁移
   - 维护API稳定性

## 重构阶段

### 第一阶段：基础结构（已开始）

- 设计新的目录结构
- 迁移和重构工具函数
- 建立基础架构

### 第二阶段：核心功能（进行中）

- 迁移事件系统
- 迁移服务层
- 重构UI组件库

### 第三阶段：业务逻辑（计划中）

- 迁移资产管理功能
- 重构编辑器功能
- 实现新的特性

### 第四阶段：优化和测试（计划中）

- 性能优化
- 编写测试用例
- 文档完善

## 入口文件(index.js)重构计划

当前的index.js文件包含了插件的核心初始化逻辑，需要重构为更模块化的结构。

### 重构目标

1. 将复杂逻辑拆分为独立模块
2. 减少全局状态和副作用
3. 提高代码可读性和可维护性
4. 实现更清晰的依赖管理

### 具体任务

1. **插件类重构**：
   - 将SACAssetsManager类拆分为核心类和功能模块
   - 实现依赖注入模式
   - 减少方法体积，提高内聚性

2. **配置管理**：
   - 将TAB_CONFIGS和DOCK_CONFIGS移至独立配置文件
   - 实现动态配置加载
   - 支持配置热更新

3. **UI管理**：
   - 重构Tab和Dock创建逻辑
   - 实现统一的UI注册机制
   - 优化Vue组件加载流程

4. **国际化处理**：
   - 重构i18n工具
   - 优化翻译流程
   - 实现更高效的字符串处理

5. **事件系统**：
   - 规范化事件名称和处理
   - 优化事件分发机制
   - 实现事件监控和调试

6. **服务初始化**：
   - 重构后台服务初始化流程
   - 实现服务依赖管理
   - 优化服务启动性能

### 新入口文件结构

```javascript
// src/index.js
import { Plugin } from "siyuan";
import { initServices } from "./services/init.js";
import { setupEventSystem } from "./events/setup.js";
import { registerUIComponents } from "./components/register.js";
import { setupI18n } from "./i18n/setup.js";
import { createServer } from "./services/server/create.js";

export default class SACAssetsManager extends Plugin {
  async onload() {
    // 初始化核心状态
    this.initCoreState();
    
    // 设置事件系统
    await setupEventSystem(this);
    
    // 初始化服务
    await initServices(this);
    
    // 注册UI组件
    await registerUIComponents(this);
    
    // 设置国际化
    await setupI18n(this);
    
    // 创建服务器
    await createServer(this);
  }
  
  // 其他生命周期方法...
}
```

## 重点挑战

1. **循环依赖**：
   - 识别和解决模块间循环依赖
   - 重新设计依赖关系
   - 使用依赖注入或中间层解决

2. **状态管理**：
   - 减少全局状态依赖
   - 实现可预测的状态流转
   - 支持状态持久化

3. **向后兼容**：
   - 维护关键API稳定性
   - 提供过渡层适配旧接口
   - 实现功能等价

4. **性能保障**：
   - 确保重构不影响性能
   - 重点优化热点代码路径
   - 实现渐进式加载

## 测试策略

1. **单元测试**：
   - 为核心工具函数编写测试
   - 测试模块接口行为
   - 验证边界条件处理

2. **集成测试**：
   - 测试模块间交互
   - 验证功能完整性
   - 模拟真实使用场景

3. **性能测试**：
   - 测试重构前后性能对比
   - 识别性能热点和瓶颈
   - 验证大数据量处理能力

## 进度跟踪

| 模块 | 开始日期 | 计划完成日期 | 实际完成日期 | 状态 | 负责人 |
|------|---------|------------|------------|------|-------|
| 工具函数(toolBox) | 2023-11-01 | 2024-02-28 | - | 进行中 | AI助手 |
| UI组件(components) | 2023-12-15 | 2024-03-31 | - | 进行中 | 团队 |
| 事件系统(events) | 2024-01-10 | 2024-02-29 | - | 进行中 | AI助手 |
| 服务层(services) | 2024-02-01 | 2024-04-15 | - | 待开始 | - |
| 入口文件(index.js) | 2024-02-15 | 2024-02-28 | - | 待开始 | - |

## 注意事项

- 重构期间维持插件功能可用
- 定期同步和更新文档
- 关注用户反馈，及时调整重构策略
- 优先迁移基础设施和核心功能
- 保持良好的错误处理和日志记录
- 每个模块迁移后进行充分测试 