# SACAssetsManager 项目重构笔记

## 这个部分由开发者编写,未经允许禁止AI修改

我们需要注意这个插件的架构需要隔离思源的环境

## 项目架构概览

SACAssetsManager 是一个思源笔记插件，其架构设计如下：

```
项目结构:
├── 插件本体层 (SACAssetsManager类) - 轻量级适配层
├── 模块系统 (Services) - 核心系统级组件
│   ├── 模块加载器 (servicesLoader) - 负责加载所有模块
│   └── 其他核心模块 - 为扩展提供基础能力
├── 扩展系统 (Extensions) - "插件的插件"
│   ├── 编译模块 - 用于实时编译扩展
│   └── 各种功能扩展
└── 工具箱 (ToolBox) - 包装外部依赖和环境能力
    ├── 基础工具
    ├── 功能特定工具
    └── 平台兼容性工具
```

## 重构目标和原则

1. **架构优化**:
   - 将当前插件结构调整为更清晰的分层架构
   - 实现"瘦插件本体层 + 强大模块系统 + 灵活扩展系统 + 统一工具箱"的结构

2. **代码风格**:
   - 主体命名风格保持中文
   - 英文仅用于外界提供的接口、对外部接口和原生环境功能
   - 全面采用函数式风格，减少类的使用(除非必要)

3. **依赖管理**:
   - 集中管理外部依赖
   - 通过工具箱包装所有外部依赖，避免直接调用
   - 思源笔记环境依赖集中管理(useSiyuan)

4. **性能优化**:
   - 减少初始化时的动态加载数量
   - 避免创建不必要的对象和函数
   - 优化关键路径的性能

## 重构计划

### 1. 工具箱重构 (进行中)
目前重点是重构工具箱(ToolBox)部分，将所有工具函数按功能域组织为不同子目录，详见 `src/toolBox/AInote.md`。

- ✅ 已完成思源环境依赖的集中化管理 (useSiyuan.js)
- ✅ 已完成部分基础工具函数的重构和整理
- ✅ 已创建兼容层保证现有代码可用
- 📋 需要继续迁移更多工具函数
- 📋 需要改进依赖管理机制

### 2. 模块系统重构 (待开始)
从`core/servicesLoader.js`开始，重构模块加载和管理系统：

- 📋 分析现有模块加载器实现
- 📋 设计更灵活的模块注册和依赖注入机制
- 📋 优化模块间通信

### 3. 扩展系统重构 (待开始)
实现灵活的"插件的插件"机制：

- 📋 设计扩展API
- 📋 实现高效的浏览器端编译模块
- 📋 建立扩展间通信机制

### 4. 插件本体层精简 (待开始)
将插件主体（SACAssetsManager类）精简为纯粹的适配层：

- 📋 移除非必要的初始化逻辑
- 📋 将业务逻辑迁移到相应模块
- 📋 优化资源加载和卸载流程

## 当前重构详情

目前重点在工具箱(ToolBox)的重构，特别是思源笔记环境依赖的集中管理。已完成:

1. 创建 `useAge/useSiyuan.js` 作为思源环境依赖的集中管理模块
2. 实现系统环境工具 (`system`)、插件环境工具 (`plugin`) 和UI相关工具 (`ui`) 命名空间
3. 添加 `useSiyuanDialog.js` 和 `useSiyuanSystem.js` 等组件化模块
4. 添加 `useSiyuanBlock.js` 模块，封装与块操作相关的API
5. 为原有工具函数添加兼容层，确保现有代码可用

## 高优先级任务 

1. **继续完善思源环境依赖**:
   - ✅ 添加`useSiyuanBlock.js`模块封装块操作
   - 📋 添加`useSiyuanWorkspace.js`模块封装工作区操作
   - 📋 添加`useSiyuanNotebook.js`模块封装笔记本操作
   - 📋 添加`useSiyuanAsset.js`模块封装资源文件操作

2. **整合工具箱目录结构**:
   - 📋 将所有功能类似的文件放在一起，避免分散
   - 📋 为每个功能域添加详细的README.md文档

3. **修复现有工具命名和接口一致性问题**:
   - 📋 统一方法命名风格
   - 📋 确保所有重构后的工具函数同时提供中英文接口

## 注意事项

1. 遵循"兼容、增强、替换"的三步走策略:
   - 先建立兼容层保证向后兼容
   - 在新位置增强功能
   - 最后逐步替换旧引用

2. 保持中文命名风格的一致性，仅在必要时使用英文

3. 优先使用函数式风格，尽量避免使用类

4. 尽可能减少外部依赖，必要时通过useDeps目录集中管理

## 参考资源

- 现有的index.js: 当前插件实现
- index new.js: 未来插件架构参考
- src/toolBox/AInote.md: 工具箱重构详细笔记 