# 本部分由开发者编写,未经允许禁止AI助手更改

目前的重点是/src/toolbox和/src/shared的构建,分散于项目各处的通用公共工具函数应该被重构到这两个位置
注意这两个模块之间的区别

# 思源笔记资源管理插件重构计划

## 重构概述

本文档描述了思源笔记资源管理插件(SACAssetsManager)的整体重构计划。该插件正在从旧的架构迁移到新的组织结构，以提高代码质量、可维护性和性能。

## 目录结构迁移

旧结构(`source/`)到新结构(`src/`)的映射关系：

| 旧目录/文件 | 新目录/文件 | 状态 | 优先级 | 备注 |
|------------|------------|------|-------|------|
| source/UI/ | src/components/ | 进行中 | 高 | UI组件和界面 |
| source/utils/ | src/toolBox/ | 进行中 | 高 | 工具函数库 |
| source/server/ | src/services/ | 待开始 | 高 | 服务器和API |
| source/events/ | src/events/ | 进行中 | 高 | 事件系统 |
| source/shared/ | src/shared/ | 待开始 | 中 | 共享资源 |
| source/servicies/ | src/services/ | 待开始 | 高 | 服务层 |
| source/triggers/ | src/middlewares/ | 待开始 | 中 | 触发器和中间件 |
| source/polyfills/ | src/toolBox/base/usePolyfills/ | 完成 | 高 | 兼容性填充 |
| index.js | src/index.js | 待开始 | 高 | 主入口文件 |

## 重构原则

1. **模块化设计**：
   - 按功能域划分模块
   - 明确模块边界和责任
   - 减少模块间耦合

2. **代码标准化**：
   - 统一命名规范（中文函数名）
   - 统一代码风格
   - 使用函数式编程风格
   - 减少类的使用

3. **性能优化**：
   - 减少不必要的计算
   - 优化资源加载
   - 实现惰性加载和按需执行

4. **增强可测试性**：
   - 编写单元测试
   - 实现功能隔离
   - 减少副作用

5. **保持兼容性**：
   - 提供向后兼容接口
   - 渐进式迁移
   - 维护API稳定性

## 重构阶段

### 第一阶段：基础结构（已开始）

- 设计新的目录结构
- 迁移和重构工具函数
- 建立基础架构

### 第二阶段：核心功能（进行中）

- 迁移事件系统
- 迁移服务层
- 重构UI组件库

### 第三阶段：业务逻辑（计划中）

- 迁移资产管理功能
- 重构编辑器功能
- 实现新的特性

### 第四阶段：优化和测试（计划中）

- 性能优化
- 编写测试用例
- 文档完善

## 入口文件(index.js)重构计划

当前的index.js文件包含了插件的核心初始化逻辑，需要重构为更模块化的结构。

### 重构目标

1. 将复杂逻辑拆分为独立模块
2. 减少全局状态和副作用
3. 提高代码可读性和可维护性
4. 实现更清晰的依赖管理

### 具体任务

1. **插件类重构**：
   - 将SACAssetsManager类拆分为核心类和功能模块
   - 实现依赖注入模式
   - 减少方法体积，提高内聚性

2. **配置管理**：
   - 将TAB_CONFIGS和DOCK_CONFIGS移至独立配置文件
   - 实现动态配置加载
   - 支持配置热更新

3. **UI管理**：
   - 重构Tab和Dock创建逻辑
   - 实现统一的UI注册机制
   - 优化Vue组件加载流程

4. **国际化处理**：
   - 重构i18n工具
   - 优化翻译流程
   - 实现更高效的字符串处理

5. **事件系统**：
   - 规范化事件名称和处理
   - 优化事件分发机制
   - 实现事件监控和调试

6. **服务初始化**：
   - 重构后台服务初始化流程
   - 实现服务依赖管理
   - 优化服务启动性能

### 新入口文件结构

```javascript
// src/index.js
import { Plugin } from "siyuan";
import { initServices } from "./services/init.js";
import { setupEventSystem } from "./events/setup.js";
import { registerUIComponents } from "./components/register.js";
import { setupI18n } from "./i18n/setup.js";
import { createServer } from "./services/server/create.js";

export default class SACAssetsManager extends Plugin {
  async onload() {
    // 初始化核心状态
    this.initCoreState();
    
    // 设置事件系统
    await setupEventSystem(this);
    
    // 初始化服务
    await initServices(this);
    
    // 注册UI组件
    await registerUIComponents(this);
    
    // 设置国际化
    await setupI18n(this);
    
    // 创建服务器
    await createServer(this);
  }
  
  // 其他生命周期方法...
}
```

## 重点挑战

1. **循环依赖**：
   - 识别和解决模块间循环依赖
   - 重新设计依赖关系
   - 使用依赖注入或中间层解决

2. **状态管理**：
   - 减少全局状态依赖
   - 实现可预测的状态流转
   - 支持状态持久化

3. **向后兼容**：
   - 维护关键API稳定性
   - 提供过渡层适配旧接口
   - 实现功能等价

4. **性能保障**：
   - 确保重构不影响性能
   - 重点优化热点代码路径
   - 实现渐进式加载

## 测试策略

1. **单元测试**：
   - 为核心工具函数编写测试
   - 测试模块接口行为
   - 验证边界条件处理

2. **集成测试**：
   - 测试模块间交互
   - 验证功能完整性
   - 模拟真实使用场景

3. **性能测试**：
   - 测试重构前后性能对比
   - 识别性能热点和瓶颈
   - 验证大数据量处理能力

## 进度跟踪

| 模块 | 开始日期 | 计划完成日期 | 实际完成日期 | 状态 | 负责人 |
|------|---------|------------|------------|------|-------|
| 工具函数(toolBox) | 2023-11-01 | 2024-02-28 | - | 进行中 | AI助手 |
| UI组件(components) | 2023-12-15 | 2024-03-31 | - | 进行中 | 团队 |
| 事件系统(events) | 2024-01-10 | 2024-02-29 | - | 进行中 | AI助手 |
| 服务层(services) | 2024-02-01 | 2024-04-15 | - | 待开始 | - |
| 入口文件(index.js) | 2024-02-15 | 2024-02-28 | - | 待开始 | - |

## 注意事项

- 重构期间维持插件功能可用
- 定期同步和更新文档
- 关注用户反馈，及时调整重构策略
- 优先迁移基础设施和核心功能
- 保持良好的错误处理和日志记录
- 每个模块迁移后进行充分测试

# 思源AI通信框架插件
> SiYuan Assets Communication Framework Plugin

## 项目概述
本项目旨在提供高效的通信框架，解决思源笔记AI相关功能开发过程中的技术挑战。项目包含服务管理、资产管理和通信代理等核心功能。

## 实现原理

### 心跳通信机制
本插件采用多层次心跳通信机制，确保各服务状态的准确监控和即时响应：

1. **结构化状态数据**
   - 心跳响应包含完整的服务状态对象，包括主服务和静态服务的详细信息
   - 每个服务状态包含isRunning、port、startTime和lastHeartbeat等关键字段
   - 使用统一的数据结构确保状态表示的一致性，便于UI展示和故障诊断

2. **服务状态缓存**
   - 插件主实例维护服务状态缓存(`servicesStatus`)，实时反映最新服务状态
   - 状态缓存通过心跳响应自动更新，确保数据的实时性和准确性
   - 缓存机制减少频繁状态查询的需要，提高系统效率

3. **事件驱动状态更新**
   - 状态变更时通过事件总线广播`service:status-updated`事件
   - UI组件订阅状态更新事件，实时反映服务状态变化
   - 分离状态监测和UI更新逻辑，实现松耦合架构

4. **多级故障检测**
   - 定时自动检测与手动检测相结合
   - 针对不同服务类型采用不同的检测策略：
     - 主服务：使用IPC通道心跳检测
     - 静态服务：使用BroadcastChannel进行通信
   - 检测到服务停止时立即触发状态更新和通知事件

5. **心跳模块化**
   - 将心跳处理逻辑独立为单独模块，便于维护和扩展
   - 提供统一的API接口进行服务状态查询和更新
   - 支持跨进程心跳检测，适应插件的多进程架构

### 服务管理
插件实现了完善的服务生命周期管理：

1. **服务自动恢复**
   - 检测到服务异常时，尝试自动重启相关服务
   - 维护服务启动记录，避免频繁重启
   - 提供手动服务管理界面，允许用户干预

2. **服务状态可视化**
   - 直观展示各服务运行状态、运行时长和响应时间
   - 服务状态变化时提供视觉反馈
   - 支持服务详细信息查看和问题诊断

## 模块概览

### 心跳通信模块
- `source/server/heartbeat.js` - 心跳响应处理核心模块
- `index.js` - 插件主实例中的心跳检测和状态管理
- `source/UI/pannels/serviceManager/serviceMonitor.vue` - 服务状态监控界面

### 服务管理模块
- `source/server/main.js` - 主服务实现
- `source/server/staticServerEntry.html` - 静态服务实现

## 技术亮点

1. **事件驱动架构**
   - 通过事件总线实现组件间松耦合通信
   - 状态变更事件驱动UI更新，减少轮询开销
   - 服务控制命令通过事件触发，简化接口调用

2. **多层次状态存储**
   - 全局状态缓存保证一致性
   - 本地状态响应变化提高界面响应速度
   - 双向状态同步确保数据一致性

3. **异步非阻塞操作**
   - 所有心跳检测和状态更新操作均为异步执行
   - 状态检测失败不会阻塞其他功能
   - 使用Promise和async/await简化异步流程

4. **错误恢复机制**
   - 服务异常自动检测和恢复
   - 心跳通信失败优雅降级
   - 全面的错误捕获和日志记录 